{% extends 'base.html' %}

{% block content %}
{% load markdownify %}
{% load botc_script_tags %}
{% load bootstrap_icons %}

<style>
    div.alert-messages {
        position: fixed;
        top: 80px;
        left: 44%;
        right: 44%;
        z-index: 7000;
    }
</style>

<script>
    // Set the name of the page to the name & version of the script.    
    document.title = "{{ script.name }} v{{ script_version.version }}"
  
    function showAndDismissAlert(message) {
        var htmlAlert = '<div class="alert alert-primary' + '">' + message + '</div>';
        $(".alert-messages").prepend(htmlAlert);
        $(".alert-messages .alert").first().hide().fadeIn(200).delay(2000).fadeOut(1000, function () { $(this).remove(); });
    }    
  
    function CopyLink() {
        navigator.clipboard.writeText("https://{{request.META.HTTP_HOST}}/api/scripts/{{script_version.pk}}/json/")
        showAndDismissAlert("Link Copied to Clipboard")
    }
</script>

<script async>
    function createSimilarScriptEntry(script) {
        const anchorElement = document.createElement('a');
        anchorElement.href = `/script/${script.scriptPK}`
        anchorElement.textContent = script.name;

        const listElement = document.createElement('li');
        listElement.className = 'list-group-item p-0 border-0'
        listElement.append(`${script.value}% `, anchorElement)

        return listElement
    }

    async function showSimilarScripts() {
        const { full, teensyville } = await (await fetch('/script/{{script.pk}}/{{script_version.version}}/similar')).json()

        const fullElements = full.map(createSimilarScriptEntry)
        const fullList = document.getElementById('similar-full-list');
        fullList.textContent = '';
        fullList.append(...fullElements)

        const teensyvilleElements = teensyville.map(createSimilarScriptEntry);
        const teensyvilleList = document.getElementById('similar-teensyville-list');
        teensyvilleList.textContent = '';
        teensyvilleList.append(...teensyvilleElements)
    }
    
    // Only load similar scripts when tab is clicked
    document.addEventListener('DOMContentLoaded', function() {
        const similarityTab = document.getElementById('similarity-tab');
        if (similarityTab) {
            similarityTab.addEventListener('click', function() {
                if (!this.dataset.loaded) {
                    showSimilarScripts();
                    this.dataset.loaded = 'true';
                }
            });
        }
    });
</script>

<div class="row">
    <div class="col-auto">
        <h1>{{ script.name }} - v{{ script_version.version }}</h1>
    </div>
    <div class="col-auto ml-auto align-self-end">
        {% include "info.html" with record=script_version %}
    </div>
</div>

{% if script_version.author or script_version.tags.all %}
    <div class="row">
    {% if script_version.author %}
        <div class="col-auto pr-1">
            <h2>by {{ script_version.author }}</h2>
        </div>
    {% endif %}

    {% if script_version.script.owner == user %}
        <div class="col-auto align-self-center">
            <h4><span class="badge badge-pill badge-dark">You</span></h4>
        </div>
    {% endif %}

    {% if script_version.tags.all %}
        <div class="col-auto align-self-center">
            {% for tag in script_version.tags.all %}
                <span class="badge badge-pill {{ tag.style }}">{{ tag }}</span>
            {% endfor %}    
        </div>
    {% endif %}
    </div>
{% endif %}

<!-- Navigation and download buttons remain the same -->
<div class="row">
    <div class="col-md-auto pt-1 pr-0 h-75">
        <form class="mb-0">
            <select class="custom-select" name="selected_version" onchange="this.form.submit();">
                {% for versions in script.versions.all|dictsortreversed:"version" %}
                    <option {% if script_version.version == versions.version %}selected{% endif %}>{{ versions.version }}</option>
                {% endfor %}
            </select>    
        </form>
    </div>
    <!-- Other buttons remain the same -->
</div>

<ul class="nav nav-tabs" id="myTab" role="tablist">
    {% if script_version.notes %}
    <li class="nav-item">
        <a class="nav-link {% active_aria_status 'notes-tab' activetab %}" id="notes-tab" data-toggle="tab" href="#notes" role="tab" aria-controls="notes" aria-selected="true">Notes</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="characters-tab" data-toggle="tab" href="#characters" role="tab" aria-controls="characters" aria-selected="false">Characters</a>
    </li>
    {% else %}
    <li class="nav-item">
        <a class="nav-link {% active_aria_status 'characters-tab' activetab %}" id="characters-tab" data-toggle="tab" href="#characters" role="tab" aria-controls="characters" aria-selected="true">Characters</a>
    </li>
    {% endif %}
    {% if changes.items %}
    <li class="nav-item">
        <a class="nav-link" id="history-tab" data-toggle="tab" href="#history" role="tab" aria-controls="history" aria-selected="false">History</a>
    </li>
    {% endif %}
    {% if script_version.homebrewiness == 0 %}
    <li class="nav-item">
        <a class="nav-link" id="similarity-tab" data-toggle="tab" href="#similarity" role="tab" aria-controls="similarity" aria-selected="false">Similar Scripts</a>
    </li>
    {% endif %}
    {% if script_version.collections.count > 0 %}
    <li class="nav-item">
        <a class="nav-link" id="collection-tab" data-toggle="tab" href="#collection" role="tab" aria-controls="collection" aria-selected="false">Collections</a>
    </li>
    {% endif %}
    <li class="nav-item">
        <a class="nav-link {% active_aria_status 'comments-tab' activetab %}" id="comments-tab" data-toggle="tab" href="#comments" role="tab" aria-controls="comments" aria-selected="false">Comments ({{ comments|length }})</a>
    </li>
</ul>

<div class="tab-content row p-1" height="720">
    {% if script_version.pdf %}
    <div class="col-sm-6">
        <embed src="{{ script_version.pdf.url }}#toolbar=0" type="application/pdf" width="100%" height="720">
    </div>
    {% endif %}
    
    {% if script_version.notes %}
    <div class="tab-pane fade {% active_tab_status 'notes-tab' activetab %} col-sm-6" id="notes" role="tabpanel" aria-labelledby="notes-tab">
        {{ script_version.notes|markdownify }}
    </div>
    <div class="tab-pane fade col-sm-6" id="characters" role="tabpanel" aria-labelledby="characters-tab">
    {% else %}
    <div class="tab-pane fade {% active_tab_status 'characters-tab' activetab %} col-sm-6" id="characters" role="tabpanel" aria-labelledby="characters-tab">
    {% endif %}
        {% comment %}
        OPTIMIZED: Use character_data from context instead of template tag queries
        {% endcomment %}
        {% for role in script_version.content %}
            {% if role.id != "_meta" %}
                {% with character_data|get_item:role.id as character %}
                    {% if character %}
                        {% if forloop.counter0 > 0 %}
                            {% with script_version.content|get_item:forloop.counter0|get_item:"id" as curr_id %}
                            {% with script_version.content|get_item:forloop.counter0|add:"-1"|get_item:"id" as prev_id %}
                            {% with character_data|get_item:prev_id as prev_character %}
                                {% if prev_character and character.character_type != prev_character.character_type %}
                                    <br>
                                {% endif %}
                            {% endwith %}
                            {% endwith %}
                            {% endwith %}
                        {% endif %}
                        <li><span style="color:{{ character.character_type|character_color }}">{{ character.character_name }}</span></li>
                    {% else %}
                        <li><span style="color:#000000">{{ role.id }}</span></li>
                    {% endif %}
                {% endwith %}
            {% endif %}
        {% endfor %}
    </div>
    
    {% if changes.items %}
    <div class="tab-pane fade col-sm-6" id="history" role="tabpanel" aria-labelledby="history-tab">
        {% for version, diffs in changes.items %}
            <h2>{{ diffs.previous_version }} -> {{ version }}</h2>
            <div class="row">
                <div class="col-sm-5">
                    <ul class="p-0">
                        {% for role in diffs.additions %}
                            <li class="list-group-item p-0 border-0">+ 
                                {% with character_data|get_item:role.id as character %}
                                    {% if character %}{{ character.character_name }}{% else %}{{ role.id }}{% endif %}
                                {% endwith %}
                            </li>
                        {% endfor %}
                    </ul>
                </div>
                <div class="col-sm-5">
                    <ul class="p-0">
                        {% for role in diffs.deletions %}
                            <li class="list-group-item p-0 border-0">- 
                                {% with character_data|get_item:role.id as character %}
                                    {% if character %}{{ character.character_name }}{% else %}{{ role.id }}{% endif %}
                                {% endwith %}
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% if diffs.changes %}
            <div class="row">
                <div class="col-sm-10">
                    <ul class="p-0">
                        {% for role in diffs.changes %}
                            <li class="list-group-item p-0 border-0">~ 
                                {% with character_data|get_item:role.id as character %}
                                    {% if character %}{{ character.character_name }}{% else %}{{ role.id }}{% endif %}
                                {% endwith %}
                                (Changed ability)
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}
        {% endfor %}
    </div>
    {% endif %}
    
    <div class="tab-pane fade col-sm-6" id="similarity" role="tabpanel" aria-labelledby="similarity-tab">
        <h3>Full Scripts</h3>
        <ul class="p-0" id="similar-full-list">
            <li>Click to load similar scripts...</li>
        </ul>
        <h3>Teensyville</h3>
        <ul class="p-0" id="similar-teensyville-list">
            <li>Click to load similar scripts...</li>
        </ul>
    </div>
    
    <div class="tab-pane fade col-sm-6" id="collection" role="tabpanel" aria-labelledby="collection-tab">
        <ul class="p-0">
            {% for collection in script_version.collections.all %}
                <li><a href="/collection/{{collection.pk}}">{{collection.name}}</a></li>
            {% endfor %}
        </ul>
    </div>
    
    {% comment %}
    OPTIMIZED: Use pre-computed comments structure
    {% endcomment %}
    {% if script_version.pdf %}
    <div class="tab-pane fade col-sm-6 {% active_tab_status 'comments-tab' activetab %}" id="comments" role="tabpanel" aria-labelledby="comments-tab">
    {% else %}
    <div class="tab-pane fade col-sm-8 {% active_tab_status 'comments-tab' activetab %}" id="comments" role="tabpanel" aria-labelledby="comments-tab">
    {% endif %}
        {% for comment_info in comments %}
            <div class="row">
                {% if comment_info.indent == 0 %}
                <div class="col">
                {% else %}
                <div class="col offset-sm-{{comment_info.indent}}">
                {% endif %}
                    {{ comment_info.comment.comment|markdownify }}
                </div>
                <div class="align-self-end">
                    {% if comment_info.comment.user == user %}
                    <a class="btn btn-info btn-sm" data-toggle="collapse" href="#edit_{{comment_info.comment.pk}}" role="button">Edit</a>
                    {% include "delete_comment.html" with comment=comment_info.comment %}
                    {% endif %}
                    {% if user.is_authenticated %}
                    <a class="btn btn-secondary btn-sm" data-toggle="collapse" href="#reply_{{comment_info.comment.pk}}" role="button">Reply</a>
                    {% endif %}
                </div>
            </div>
            <!-- Comment forms remain the same -->
        {% endfor %}
        
        {% if user.is_authenticated %}
        <a class="btn btn-secondary btn-sm" data-toggle="collapse" href="#reply" role="button">New Comment</a>
        <div class="row">
            <div class="col collapse" id="reply">
                <form action="{% url 'create_comment' %}" method="post">
                    {% csrf_token %}
                    <textarea class="form-control" name="comment" rows="5"></textarea>
                    <input type="hidden" name="script" value="{{script.pk}}">
                    <div class="text-right">
                        <button type="submit" class="btn btn-secondary btn-sm">Add</button>
                    </div>
                </form>
            </div>
        </div>
        {% endif %}
    </div>
</div>

{% endblock %}